{
  "hash": "0003322282d1677b6843c794bcbfcf75",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Local setup for working with Overture data\"\n# css: [pres_style.scss,default]\nexecute: \n  echo: true\n  eval: true\n  include: true\nipynb-shell-interactivity: all\nkeep-ipynb: true\nformat: \n  revealjs: \n    theme: [pres_style.scss,default]\n    fig-align: center\n    code-fold: false\nauthor: \n  - name: Ivann Schlosser\n    email: ivann.schlosser@ox.co.uk\n    url: ischlosser.com\n    affiliations:\n      - name: Oxford Progamme for Sustainable Infrastructure Systems (OPSIS)\n        address: South Parks Road\n        postal-code: OX1 3QY\n        city: Oxford\n---\n\n## Importing the data\n\nThe Overture website recommends various workflows to download the data. Among them, the one allowing to work a local and self-sufficient manner is the python based [`overturemaps`](https://github.com/OvertureMaps/overturemaps-py) CLI, available from pip. It requires few arguments: 4 numeric values for the bbox, the type of layer to extract and the type of file to write into. \n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\n!overturemaps download --bbox=west,south,east,north -f geoparquet --type=segment -o tanzania_roads.geoparquet\n```\n:::\n\n\nMore information on the values allowed in `--type` is available via the shell command `overturemaps download --help`.\n\n## Working with the data\n\n\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nimport duckdb as db\n\nafrica_roads = db.read_parquet(\"../tanzania_roads.geoparquet\")\n```\n:::\n\n\nThe data set is read as traditional parquet in which the geometry column is a `blob`. \n\n::: {.cell execution_count=4}\n\n::: {.cell-output .cell-output-display execution_count=3}\n```\n┌──────────────────────┬──────────────┬────────────────────────────────────────────────────────────────────────────────┐\n│          id          │    class     │                                    geometry                                    │\n│       varchar        │   varchar    │                                      blob                                      │\n├──────────────────────┼──────────────┼────────────────────────────────────────────────────────────────────────────────┤\n│ 089962508d97ffff04…  │ path         │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x02@<\\xD1\\xA5\\x99\\x82\\x1C\\xA5\\xC01.1\\x0D\\xB…  │\n│ 089962508d97ffff04…  │ path         │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x08@<\\xD1\\xD2\\x08u\\xF0G\\xC01.\\x0A+\\xD2\\xEC\\…  │\n│ 088962508d9fffff04…  │ path         │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x13@<\\xD1\\xA5\\x99\\x82\\x1C\\xA5\\xC01.1\\x0D\\xB…  │\n│ 089962508d83ffff04…  │ path         │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x0B@<\\xD2\\x06\\xEF\\x07\\x8A8\\xC01-\\xE34\\x17^\\…  │\n│ 08496251ffffffff04…  │ secondary    │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00c@<\\xC7\\xF8\\xAA\\xA1(\\xDA\\xC01&_\\xB8\\xCD;\\x88…  │\n│ 086962508fffffff04…  │ unclassified │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00S@<\\xD2\\x16/\\x16n\\x01\\xC01!\\xD4\\x96\\xC5\\xA9\\…  │\n│ 08496251ffffffff04…  │ unclassified │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x01\\x05@<\\xD2\\x16/\\x16n\\x01\\xC01!\\xD4\\x96\\xC5\\x…  │\n│ 087962508bffffff04…  │ track        │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00!@<\\xD3\\x9A\\x93\\x94\\x9C\\xDB\\xC01!\\xB0\\xFA\\x0…  │\n│ 086962508fffffff04…  │ track        │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00:@<\\xD4\\xB9\\x9F\\xC9^\\x83\\xC01\\x1En\\xE9\\xC2\\x…  │\n│ 087962508bffffff04…  │ track        │ \\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x003@<\\xD1\\xBA\\x0B\\xFF\\xE8\\x83\\xC01\\x1Ew\\xA7\\xD…  │\n├──────────────────────┴──────────────┴────────────────────────────────────────────────────────────────────────────────┤\n│ 10 rows                                                                                                    3 columns │\n└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘\n```\n:::\n:::\n\n\nThe `duckdb` loaders do not support reading *geoparquet* at the moment, but this feature is expected in the upcoming version. We stick to this format for its efficiency when storing large extracts.\n\nTo further work with the geometry, we install the `duckdb` extension. \n\n::: {.cell execution_count=5}\n``` {.python .cell-code}\n# installing and loading the extension.\ndb.install_extension(\"spatial\")\ndb.load_extension(\"spatial\")\n```\n:::\n\n\n## Basic interaction with the data\n\nStill with the `duckdb` package and its SQL-like syntax.\n\n#### Counting values\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\ndb.sql(\"SELECT count(*) as N_segments,class FROM africa_roads GROUP BY class;\")\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\n┌────────────┬───────────────┐\n│ N_segments │     class     │\n│   int64    │    varchar    │\n├────────────┼───────────────┤\n│    1249548 │ path          │\n│       1481 │ parking_aisle │\n│        263 │ crosswalk     │\n│        144 │ cycleway      │\n│     502882 │ track         │\n│      69192 │ secondary     │\n│        459 │ alley         │\n│         29 │ bridleway     │\n│      83290 │ unknown       │\n│       3974 │ driveway      │\n│      44763 │ trunk         │\n│      27548 │ primary       │\n│        373 │ steps         │\n│        457 │ pedestrian    │\n│         93 │ NULL          │\n│         63 │ motorway      │\n│    1792660 │ residential   │\n│      57044 │ footway       │\n│    1128458 │ unclassified  │\n│     148719 │ tertiary      │\n│       2473 │ living_street │\n│        319 │ sidewalk      │\n├────────────┴───────────────┤\n│ 22 rows          2 columns │\n└────────────────────────────┘\n```\n:::\n:::\n\n\n## Data Manipulation\n\nThe advantage of working with `duckdb` is that intensive computations are performed outside the python environment, and all we need to do is *collect* the results.\n\n### Etracting a subset\n\n::: {.cell execution_count=7}\n``` {.python .cell-code}\n# filtering out cycleways\nafrican_cycleways = db.sql(\"Select id,ST_GeomFromWKB(geometry) as geometry,subtype,class from africa_roads where class='cycleway'\")\n\n# intermediate step: transform the geometry into WKT and read the subset of data as a pandas DataFrame\nafrican_cycleways_wkt = db.sql(\"select id, ST_AsText(geometry) as geometry, subtype, class from african_cycleways;\").df()\n\n# Finally, convert the geometry and create a geopandas GeoDataFrame. \nafrican_cycleways_df = gpd.GeoDataFrame(african_cycleways_wkt\n                                        ,geometry=gpd.GeoSeries.from_wkt(african_cycleways_wkt[\"geometry\"])\n                                        ,crs=4326)\nafrican_cycleways_df.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>id</th>\n      <th>geometry</th>\n      <th>subtype</th>\n      <th>class</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0889636cd65fffff047f5a85ff973bfd</td>\n      <td>LINESTRING (33.65138 -14.39933, 33.65134 -14.3...</td>\n      <td>road</td>\n      <td>cycleway</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0899636cd657ffff047ffa9b15dabfa0</td>\n      <td>LINESTRING (33.65138 -14.39933, 33.65144 -14.3...</td>\n      <td>road</td>\n      <td>cycleway</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0849636dffffffff047fdae8942610aa</td>\n      <td>LINESTRING (33.65680 -14.39324, 33.65672 -14.3...</td>\n      <td>road</td>\n      <td>cycleway</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>08896365259fffff047fdd5d17801613</td>\n      <td>LINESTRING (33.65716 -14.39347, 33.65703 -14.3...</td>\n      <td>road</td>\n      <td>cycleway</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0849636dffffffff047f59c9a794690d</td>\n      <td>LINESTRING (33.66181 -14.39820, 33.66149 -14.3...</td>\n      <td>road</td>\n      <td>cycleway</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nThe resulting types:\n\n::: {.cell execution_count=8}\n\n::: {.cell-output .cell-output-display execution_count=7}\n```\nid            object\ngeometry    geometry\nsubtype       object\nclass         object\ndtype: object\n```\n:::\n:::\n\n\n## Plotting\n\n::: {.cell execution_count=9}\n\n::: {.cell-output .cell-output-display execution_count=8}\n```\nText(0.5, 1.0, 'Cycleways of Tanzania')\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=8}\n```\nText(0.5, 27.666666666666647, 'Longitude [deg]')\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=8}\n```\nText(444.9554628788971, 0.5, 'Latitude [deg]')\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](presentation_files/figure-pdf/cell-10-output-4.pdf){fig-align='center'}\n:::\n:::\n\n\n",
    "supporting": [
      "presentation_files/figure-pdf"
    ],
    "filters": []
  }
}